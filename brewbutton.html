<!DOCTYPE html>
<html>
<body>
<!–– 
   Nespresso Expert - Web Bluetooth simple demo
   Peter Gullberg (2020)
   https://github.com/petergullberg/brewbutton 
  ––>

<h1>Nespresso Brewbutton</h1>
<p>This is a learning project, nothing stable or tested</p>
<p>This sample app on how to communicate with the Nespresso Expert. 
Reason of implementing it using Web Bluetooth, was that I needed to learn it.
I'm using async promises, which I find most straight forward to program with.
</p>

AuthKey (Change this accordingly:):

<input type="text" id="authKey" value="879608e27cb1f96e">
<BR><BR>
<button onclick="ConnectButton()">Connect</button>
<button onclick="StatusButton()">Status</button>
<button onclick="BrewButton()">Brew!</button>
<button onclick="ClearButton()">Clear!</button>
<button onclick="onTest()">Test!</button>


<BR><BR>
<textarea id="status" rows="1" cols="70" disabled></textarea>
<BR><BR>

<textarea id="log" rows="10" cols="70" disabled></textarea><BR>        

<script>
// GLOBALS
var device;
var server;
var auth_service;
var cmd_service;
var characteristics;

var RemoteCharacteristicAuth;
var RemoteCharacteristicCommand;
var RemoteCharacteristicStatus;


var deviceServiceUUID  = "06aa1910-f22a-11e3-9daa-0002a5d5c51b";

//?? Why is this same as deviceSErviceUUID?
const auth_ServiceUUID   = "06aa1910-f22a-11e3-9daa-0002a5d5c51b";
const auth_CharUUID         = "06aa3a41-f22a-11e3-9daa-0002a5d5c51b";

const cmd_ServiceUUID    = "06aa1920-f22a-11e3-9daa-0002a5d5c51b";
const cmd_CmdCharUUID       = "06aa3a42-f22a-11e3-9daa-0002a5d5c51b";
const cmd_CmdStatusCharUUID = "06aa3a12-f22a-11e3-9daa-0002a5d5c51b";

var nespressoDeviceAuth  = new Uint8Array(8);
//[0x87,0x96,0x08, 0xe2, 0x7c, 0xb1, 0xf9, 0x6e]);
//"879608e27cb1f96e"; // auth stringreplace

////////////////////////////////////////
// CODE SECTION
////////////////////////////////////////
function log_line(str){
  document.getElementById("log").innerHTML = 
  document.getElementById("log").innerHTML + str + "\n";
}
function log_clear() {
	document.getElementById("log").innerHTML = "";
}
function status_line(str){
  document.getElementById("status").innerHTML = str;
}

function ClearButton() {
  document.getElementById("log").innerHTML = "";
  document.getElementById("status").innerHTML = "";
}


perfectRecipe     = new Uint8Array([ 0x01, 0x10, 0x08, 0x00, 0x00, 0x01, 0x00, 0x82, 0x00, 0x00,0x00]);
perfectRecipeBrew = new Uint8Array([ 0x03, 0x05, 0x07, 0x04, 0x00, 0x00, 0x00, 0x00, 0x02, 0x07 ]);

async function BrewButton() {
	try {
		log_line("===================");
		log_line("Brewing coffee");

		await RemoteCharacteristicCommand.writeValue( perfectRecipe);
		await RemoteCharacteristicCommand.writeValue( perfectRecipeBrew );

		log_line("Your perfect brew is about to be delivered");
	} catch(error) {
		log_line('Argh! ' + error);
	}
}

function hex2a(hexx) {
    var hex = hexx.toString();//force conversion
    var str = '';
    for (var i = 0; i < hex.length; i += 2)
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return str;
}

// Hardcoded to 8 bytes (16 char)
function SetAuthKey(str) {
	if ( str.length != 16 ) {
		log_line("AuthKey Error\n");
		return;
	}
	for (var i = 0; i < 8; i++ ) {
		nespressoDeviceAuth[i] = parseInt(str.substr(i*2, 2), 16);	
	}
	log_line("AuthKey (dec): " + nespressoDeviceAuth);
//	return buffer;
}

// Expects a dataview...
function parse_status(view) {
	var tmp_str= "";
	var hex;
	var hex_str = "0123456789ABCDEF";		// Hard coded...

	for (var i=0; i < view.byteLength; i++) {
		hex = view.getUint8(i);
		tmp_str += hex_str.charAt((hex&0xF0)>>4);
		tmp_str += hex_str.charAt(hex&0x0F);
		tmp_str += " ";
	}
	
	val_buf = "Status: hex(" + tmp_str + ") : ";
	if ( view.getUint8(0) & 0x01 ) // Water empty
		val_buf += "no water ";
	if ( 0x84 == (view.getUint8(1) & 0x84) ) // capsule engage
		val_buf += "coffe! ";
	if ( 0x04 == (view.getUint8(1) & 0x84) )
		val_buf += "water ";
	if ( 0x02 == view.getUint8(1) )
		val_buf += "idle";

	status_line(val_buf);
}

function onDisconnected(event) {
  document.getElementById("log").innerHTML = "";
  status_line("Disconnected");
}

function handleStatusNotification(event) {
  let view = event.target.value;
  parse_status(view);
}

async function StatusButton() {
  try {
	if ( RemoteCharacteristicStatus.properties.read) {
		log_line('Reading status');
		const view = await RemoteCharacteristicStatus.readValue();
		parse_status(view);
		
	}
  } catch(error) {
    log_line('Argh! ' + error);
  }
}

function onTest() {
	log_line("Not very much in this function");
}
async function ConnectButton() {

	// Clear log
	log_clear();
  
	SetAuthKey( document.querySelector('#authKey').value );

	if (deviceServiceUUID.startsWith('0x')) {
		deviceServiceUUID = parseInt(deviceServiceUUID);
	}
  if (auth_CharUUID.startsWith('0x')) {
    auth_CharUUID = parseInt(auth_CharUUID);
  }


  try {
    log_line('Requesting Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
		filters: [
			{services: [deviceServiceUUID]},
			{services: [cmd_ServiceUUID]}
		]
		
	});

    log_line('Connecting to GATT Server...');
	device.addEventListener('gattserverdisconnected', onDisconnected);

    server = await device.gatt.connect();

    log_line('Getting Service...');
    auth_service = await server.getPrimaryService(auth_ServiceUUID);
    cmd_service = await server.getPrimaryService(cmd_ServiceUUID);

    log_line('Getting Characteristic...');
    //characteristic = await service.getCharacteristic(auth_CharUUID);
	RemoteCharacteristicAuth    = await auth_service.getCharacteristic(auth_CharUUID);
/*
    log_line('> Characteristic UUID:  ' + characteristic.uuid);
    log_line('> Broadcast:            ' + characteristic.properties.broadcast);
    log_line('> Read:                 ' + characteristic.properties.read);
    log_line('> Write w/o response:   ' +
      characteristic.properties.writeWithoutResponse);
    log_line('> Write:                ' + characteristic.properties.write);
    log_line('> Notify:               ' + characteristic.properties.notify);
    log_line('> Indicate:             ' + characteristic.properties.indicate);
    log_line('> Signed Write:         ' +
      characteristic.properties.authenticatedSignedWrites);
    log_line('> Queued Write:         ' + characteristic.properties.reliableWrite);
    log_line('> Writable Auxiliaries: ' +
      characteristic.properties.writableAuxiliaries);
*/
    log_line("Sucess?");
	

	if ( RemoteCharacteristicAuth.properties.write ) {
		log_line('Writing Auth');
		await RemoteCharacteristicAuth.writeValue(nespressoDeviceAuth);
	}
	log_line("authenticated");

	RemoteCharacteristicCommand = await cmd_service.getCharacteristic(cmd_CmdCharUUID);
	RemoteCharacteristicStatus  = await cmd_service.getCharacteristic(cmd_CmdStatusCharUUID);
		
	await RemoteCharacteristicStatus.startNotifications();
    log_line("Notifications started");
    RemoteCharacteristicStatus.addEventListener('characteristicvaluechanged',
        handleStatusNotification);

	StatusButton();
	
  	  
  } catch(error) {
    log_line('Argh! ' + error);
  }
}

</script>

</body>
</html>
